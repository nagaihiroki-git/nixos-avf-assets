name: Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build NixOS components
        run: |
          nix build
          cp -L result/vmlinuz vmlinuz
          cp -L result/initrd.img initrd.img
          cp -L result/store-paths store-paths
          cp -L result/toplevel-path toplevel-path

      - name: Create Btrfs root image
        run: |
          sudo apt-get install -y btrfs-progs

          TOPLEVEL=$(cat toplevel-path)

          # Create 4GB Btrfs image
          truncate -s 4G rootfs.img
          mkfs.btrfs -L nixos rootfs.img

          # Mount and populate
          sudo mkdir -p /mnt/nixos
          sudo mount -o loop,compress=zstd:1 rootfs.img /mnt/nixos

          sudo mkdir -p /mnt/nixos/nix/store
          sudo mkdir -p /mnt/nixos/etc

          # Copy Nix store closure
          cat store-paths | while read path; do
            sudo cp -a "$path" /mnt/nixos/nix/store/
          done

          # Create basic files
          echo "pawn-vm" | sudo tee /mnt/nixos/etc/hostname
          sudo ln -s "$TOPLEVEL/init" /mnt/nixos/init

          sudo umount /mnt/nixos

      - name: Create GPT disk image
        run: |
          sudo apt-get install -y gdisk

          PART_SIZE=$(stat -c%s rootfs.img)
          DISK_SIZE=$((PART_SIZE + 8 * 1024 * 1024))

          truncate -s $DISK_SIZE seed.raw
          sgdisk -n 1:2048:0 -t 1:8300 seed.raw

          dd if=rootfs.img of=seed.raw bs=512 seek=2048 conv=notrunc

          zstd -19 -T0 seed.raw -o seed.raw.zst

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          files: |
            vmlinuz
            initrd.img
            seed.raw.zst
            ssh/insecure_key
            ssh/insecure_key.pub
