name: Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build NixOS components
        run: |
          nix build \
            --extra-substituters "https://nixos-apple-silicon.cachix.org" \
            --extra-trusted-public-keys "nixos-apple-silicon.cachix.org-1:8psDu5SA5dAD7qA0zMy5UT292TxeEPzIz8VVEr2Js20="
          cp -L result/vmlinuz vmlinuz
          cp -L result/initrd.img initrd.img
          cp -L result/store-paths store-paths
          cp -L result/toplevel-path toplevel-path

      - name: Create GPT disk with XFS
        run: |
          sudo apt-get install -y gdisk xfsprogs

          TOPLEVEL=$(cat toplevel-path)

          # Create 5GB disk image
          truncate -s 5G seed.raw

          # Create GPT with 4KB alignment
          sgdisk -a 4096 -n 1:2048:0 -t 1:8300 seed.raw

          # Setup loop device with partition scanning
          LOOP=$(sudo losetup -fP --show seed.raw)

          # Format with XFS (rock solid, no alignment issues)
          sudo mkfs.xfs -f -L nixos "${LOOP}p1"

          # Mount and populate
          sudo mkdir -p /mnt/nixos
          sudo mount "${LOOP}p1" /mnt/nixos

          sudo mkdir -p /mnt/nixos/nix/store
          sudo mkdir -p /mnt/nixos/etc

          # Copy Nix store closure
          cat store-paths | while read path; do
            sudo cp -a "$path" /mnt/nixos/nix/store/
          done

          # Create basic files
          echo "pawn-vm" | sudo tee /mnt/nixos/etc/hostname
          sudo ln -s "$TOPLEVEL/init" /mnt/nixos/init

          # Sync and unmount
          sync
          sudo umount /mnt/nixos
          sudo losetup -d "$LOOP"

          # Compress
          zstd -19 -T0 seed.raw -o seed.raw.zst

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          files: |
            vmlinuz
            initrd.img
            seed.raw.zst
            ssh/insecure_key
            ssh/insecure_key.pub
